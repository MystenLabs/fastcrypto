// Copyright (c) 2022, Mysten Labs, Inc.
// SPDX-License-Identifier: Apache-2.0

#[macro_use]
extern crate criterion;

use std::rc::Rc;

use criterion::measurement::Measurement;
use criterion::{BenchmarkGroup, Criterion};
use num_bigint::{BigInt, BigUint};
use num_traits::Num;

use fastcrypto_vdf::groups::class_group::discriminant::Discriminant;
use fastcrypto_vdf::groups::class_group::QuadraticForm;
use fastcrypto_vdf::groups::rsa_group::modulus::GOOGLE_RSA_MODULUS_4096;
use fastcrypto_vdf::groups::rsa_group::RSAGroupElement;
use fastcrypto_vdf::vdf::wesolowski::{DefaultRSABasedVDF, DefaultVDF};
use fastcrypto_vdf::vdf::VDF;

struct VerificationInputs {
    iterations: u64,
    discriminant: String,
    result: String,
    proof: String,
}

fn verify_single<M: Measurement>(parameters: VerificationInputs, c: &mut BenchmarkGroup<M>) {
    let discriminant =
        Discriminant::try_from(-BigInt::from_str_radix(&parameters.discriminant, 16).unwrap())
            .unwrap();
    let discriminant_size = discriminant.bits();

    let result_bytes = hex::decode(parameters.result).unwrap();
    let result = bcs::from_bytes(&result_bytes).unwrap();

    let proof_bytes = hex::decode(parameters.proof).unwrap();
    let proof = bcs::from_bytes(&proof_bytes).unwrap();

    let input = QuadraticForm::generator(&discriminant);

    let vdf = DefaultVDF::new(discriminant.clone(), parameters.iterations);
    c.bench_function(discriminant_size.to_string(), move |b| {
        b.iter(|| vdf.verify(&input, &result, &proof))
    });
}

fn verify(c: &mut Criterion) {
    let mut group = c.benchmark_group("VDF verify".to_string());

    // Test vectors are created using the following code:
    // ```
    // let discriminant = Discriminant::try_from(-BigInt::from_str_radix(&parameters.discriminant, 16).unwrap()).unwrap();
    // let input = QuadraticForm::generator(&discriminant);
    // let (result, proof) = DefaultVDF::new(discriminant.clone(), iterations).evaluate(&input).unwrap();
    // ```

    //1024 bits
    verify_single(VerificationInputs {
            iterations: 1000    ,
            discriminant: "cd711f181153e08e08e5ba156db0c4e9469de76f2bd6b64f068f5007918727f5eaa5f6a0e090f82682a4ebf87befdea8f1253265d700ee3ca6b0fdb2677c633c7f37b62f0e0c13b402def0ba9abaf15e4c53bfb6bda0c7a0cad4439864af3eb9af6d6c4b10286eb8ff5e2de5b009196bc60c3000fde8d4b89b7674e61bc2d23f".to_string(),
            result: "40704823bbe7ab27b8323113c31796ab1d3b4cfd904ce06bf910031227b3de511a71e6124dbdbe36103dc3dbb9091525477aec163645c1bf5290c2f6cf398cc73940eab47036267ee4ec1f222a38da58ec4291b919b2a51c5feed92d9b5b4a1080e73edc93224fceb0d70b333705d709701fa88ac96f1fbf7bd7b741269bd0d05acf40761c45472ff5f3fcc4334e56b802bd7c7f9f2098a729a2a3e897be0b3717b3363d67c6a4aa81b26b5ce4243c409e4be2d468b515ed1f76fe1c5bf76424aba4a8".to_string(),
            proof: "404a31d84c968019d6aadc2b93733ce44161ed08424deae4c1f25ae2778846b8a3f5e1049da383e711dd7cc0c3ff2d84480c3af8d2265536640f84e0bc432dc6d04029a8a68bb5d0b4874bd6f134ef96546f97eb0ea7de639fe6c73c74f4af590dc98b362ee63ac94bd9e071a33d3a79f013ad663f19ce2b84f783862db2d9e1823f4100b70f921bfa9d847f71de0d283e447227554729201161a79ae5c9891dabb141deeef63436298c3f2e4ccfbc5376df661104d76fef0e6611ee7a05c5d14a6c38f3".to_string(),
        }, &mut group);

    // 2048 bits
    verify_single(VerificationInputs {
            iterations: 1000,
            discriminant: "f6901cd003679e2f451cda55b032fb49222a9b595b9e5948b793d2d7338d4da01937c637739e7f980d481b742c0fdc5255847ccc848359db822ed6ca7f33bdd54a207e24679c9f1f7e64be59e1bed7afbaa999770743984ed997c2c8187b5a80a0df200c040ac152dd6bb3bfdf3a7f151f2ddbd9debf6c841cebdc9f450cb42f51529ba04e6bda874b43461ed104b39257559bed53200d093f8e6c48f2b1c91e15e37ce695924eafd78fa4ba11e519f9a885399264d1a885d353ce128f1e044ef2feda125167e38ad5db7931b752847388c900868bc6bff2d83f7a6e055c618d3abc0ae104520df25508f40323c35d2d992303e12f1ae7bc44ffd5861d9f768f".to_string(),
            result: "800150975db828b2cb0d2acf951ec73d5a9d603510b15a353654bee47b557a0691e3d3adf6ebc44dfd87dc39037722945b9d81ab72d0b8b7e290f25e9ea8a426ea7855276b1239121e2da32381b8a2fe555b73ffb1d7e090a3ad0f187576860bfe3df671eb5dcd4d85cdf68f8866f0c76346c6d07982c2a11a32e1f66ddf70c42212800136d4b31698bda17265b866d44782c6caf91512b12178d7a748084ed220bbc36b0f61dbd9bd1d1548e25c881691d402d5ac6d718c919dac072f255134562a3b3ce9c30235cf0840cf7dba6ddc385a977d3608a1171f144a5405de75db256cfbe64d60a9becde94293e26a9c55cb03eb1708a435a4e8d147e4bc4953372f452677810100cd211babff20059b0ac32c591891f459b0282d99cc59fa1e3d5beda0224a775a5ae083ad912847b1092df93566d2823c98f4ecd3b386a9dec85592c074256159aeb5b849de4f400a28c43c968268b503ae9d9c4d37ac8e21632b8a1f8e53ac8f1303ac77f53ab5327967520b6baef8b7e8b5ef7bf8c94c89d39c334c8884b95c".to_string(),
            proof: "8001131dffe919c531eee75e67a30b0d2dadd407fca59ae31d68b1975b1d5fbaff394fc9aae1a554c304377dbede623b94e9d2ddded9185eebb284dd36688c140cf302c34c2430f71e9fa20f7439a168d8a37fed05fbafa5dd534740bcddf9cd2d85e9dabb0c34578243dd343d8afe98368c977c03113e8ac091263785b6a3050ea68001080bcccfe4b6fcfe5f867254e948d74797c87b6867f6e6b08aa3d7bb1faeea983b2247aed245236edef16202d04523aebbd12427aaf82d87448d70f973cc2fe36105449926396025346e35c6d2d50f24bb25711bd0ec03e6a2881971d1a6d3b6fdde96ef170c378fb4964164e7de5576a4e9b2f0c4382780e993a9c998a737878101033a488b23f24d053e803effc0812b36e0c9e5a254f955687aa3fb07780eecb35d2320e1e17c6c082229d7a7ea8e7e8bee3ecf62b5f537a95dad9995410ffc08cfb14f47c8fedfdc1216d5660969e803818a73066716c8d02362ae19acebbff3354e6af3af4e9447d9ebd0df46dd09a7ae155eb0b869026c4f984d4d97313a6128".to_string(),
        }, &mut group);

    // 2400 bits
    verify_single(VerificationInputs {
        iterations: 1000,
        discriminant: "c3811f4ad2f4a7bdf2ed89385866ad526c6dd3aa942e04c141d0562a8e7b014f08804f47b3c2ecbba0a5a0ad8f4d8e869a10cff13dbc522aea141f6d1c42913f2d3bff8d3e7656c72523a2e9d47f838234bd65f05ef3ca86c2f640bca6630ed8d1da21e30a67f83e25b89c32c2d0dc0bacb81bd971b0932a82d131b4a74bff36b60b66543105da2c3ecb1a4e8c2cb6d47c1e85942cce8f3fc50c27856e6dfbd15c0bd5017fea15ae0eb43dfb32b2d947c3131d1951f00bcc40352eeb65e364551e40d13768f443406760ee6b37a5b5819d3f630c034c7f42212ad49c803772aaafd4cd1f87697c68d5a6b0855f475b370b20058558993e76759caa38edbc82407b4e3559bade5f7479a860ebef62fed82d657765ebb8f7f375c2b78f73669760e4bd4932177087a49a0b68d7".to_string(),
        result: "960129b2906c547868b3c04455ee0db11d4cb13bb1241137b1532b800e5d85088e03a082edd21ded9db78a1946fe3c96f01b831f5869a8a2c8ca585372a83377a3094170fc61ee677a0cfd4c2581158a052ca87fda074ab3ad9091a53966e709dc6bdf0776dff21e4b655ec94883d9624ab9bae72cab1dcac525adfae968bec122942c8a64e2cd651a696d0b16d3881e40f635ab6c72eb32960128414179f63cc5b483002e73e390a2f5a7d3180b36649852e2ed1980eacea1af51856ae0cfbfc9c3fdb6167ed57de459e3e701c0b4c2f1a5cafa316d2bb507d02536ca086edf717fdc25be85924a9ec7f60eba8ab5d2e5721a542c814cdb0107e320b1ead81ec716e25b774b6e9e347de019a0437b422381bb9cc54daf457d430577299f1042f18abf51e79cdad0a8b60cfd9f17a09797010135c9c1d72071b19c296c58aa0cd838ba0e1add3ce184d893d36795e17e4c23ab2f8d60a6c3416dc492e98fce7287d539f8c0f6fe1de1908200aed375a2808d625b5480a68aef2fe9a97aed2dd848a4ff4f65b98043fc3633439a25a38ae6b66969f11b26ed386aff638c5e9014cd2741e2f7761084697732f1c0bfca1e78013868e6484dda84ba94b6fdb85bb83f0273439fa30c4e45".to_string(),
        proof: "96010af999d107f0ea1b0dc8a9a9a3e7c5300f8d1054005b0a1ab335f4554bb2229fed7a537531e388d89d0439a5ddb9904037e3c517ef5d76fbeeb9c55d322064f7afbb300a359f30e7c416b43f29d19e7b6b6e68b928b37a78b1e2781c0496e1896e8ada5fcfc23ab1b942e9dd62b1dac9d194bf14e815dbae3337751932445a2663fa9c95123fb883bf538d26c72113c49f64abd9296c9601f53661e65560352fb9bce1a91f224eaabb860c45fdd56821d48e0c874a063e19b8be0f8648081a706c4297a9834e7580b0ce2fb857ce7e061c67364fbf095c4d3994ba1f778571dec4b63e5af169c261aa4433ffdb9150126481fdb050302195582171cf3034b47206f047ce4963659b8aa3501acd1517b5c5a19c179743b50ac96228a5603d9e33942b6ce0827b9b6590fd290e408397010476b8bb921b988bf0b7de4ecc9d49bd11ea47f03f8a3e1fa8ae404ded5dd20dcca97e5995ec5d5f8fbf9c1c340a90a738771a9b8e1a9fc3d65a95cfe43e40fbbaa82380d8a04803c1ada0dde0b8d5141fd51e3c0705dabcf4b9eca2562c66694a34777b59eee09063b99560b6135e1fb94209ecce7b4a58aeb36150027a65c6893403afc2496564f498b965fab824a05221089b93889a".to_string(),
    }, &mut group);

    // 3072 bits
    verify_single(VerificationInputs {
        iterations: 1000,
        discriminant: "ca25a5acb1857bd8defd2c2df2daf2b45c980c7051f325c6c1c988f70c69a1083b2fc2167d5bd49c459a67395c2adf26d2f55076c9e77bd777c1e4b195271f0d76bf4bf763a2b1d05b09627567d44175fcfa02ff7b44688b182aaafa17625c87c219e4855fdc1d574d6a5032fd640c5dc3fc2452ccb3c20e1b859e9a18384935ff94971f221983bc96aa7db8d3f311b45f27de6bd7401a7ffc020742f822089dd8b4c43e6ae1818124156830b0905ccfc2c3a87f999902a15ce5c58c5fd0d07e6fb182c0801c81fecab479b69a0a215f732fff8f15edb166508624549c56a7490358544e1f7e65f687262f005c37f66d44130efa98270abde4ee11e6d4a2ed2a051e943a3503f898f2fdcf2501291240af1520b2b0fe3aaa68448b99f0196ef66e2ebdb53d4269c7a8d3839f519f51276aec12d2983a3ce564af1a6ad81b2c555c963b3ed779c7177fdabaeb132456dc9b1151d367f867f899260d8b7c0fc3bbad1c1731b04a71286362830c5bc0fb37e5e06492e561f4f044d69a71ce41bfbf".to_string(),
        result: "c0016e09873e2a5b0b19e837f7c6e87361051594c0b20485036e4632f3cd3d5201abbd938103e2f8bc23af68258bdf3a3a86fd7083311235c5037d9c322228a2ebf62b6ec635bd1ab74fb83b1b0175674cf755973b5a29e362c8c6f3691aa6a03a39a760950b94424428239825f172a5c1794fcd76c871e138a46455a9a704c8eb28d255b81a6bc475105a09cb95b6faef6867086c7895679846da3380208d0b66e02a4a2aef53eb30a94efe26cbe4c7c5667af3a0675ce5542cbabfb1efaff7b6dcbf016e18438def5f4ec9f8b59802dc7b47305d96937c2bf9f315e960026dcde8e7ce0401da12c55f18234d2bff8181e0cdc3633fc38c6e42c0da4b1001c2bf6e2cc281b57ab138230fe4347f6f88b659ae35db38ff184171a61122873d21672e8fcda14329f88d6257dd2b7fba4e1b48f6d1818468eaa4a9b2fcf31659df2d809dcb87f7be24990b2ecc796cfe82e5e9cedf7ce41c00b8a398550ddcc4d692364ec31fb40a6b883ba5d210df16a75966c6be547b860598627e2fbe1de6dee03c4fc0017592cf1544ad1220830b6a00e98bdc4f5286d1837662c1ce79c5580b6c8eccaf1ec7e679069dc13afd8fb7968ea81d3d9060bb332f9af673b47851b8849d0880c0f10fb296d84014308a6449604b6ab8ef46b1be195f8f730758ebbee9a6d6b52fd19ce50489e996d2ef8dc7bbdcfea7a4ef8c84dd698e37ca51a9338a711556503f2c98efaf4c364c46dba79d3f58bdab292e9cddee70c27c398209928b41bea11c3ecf2dbb382c63e9e873319cec0f5fef80d1c245e08e40b56b9cf47b020e".to_string(),
        proof: "c0016392ef989dc13c16122e00250a3ae9fca3409deafaf9e6aa134899653d1f16d7cd4e153ea89b5dbe72ac2f4d7dceee2630948ae3b0afe0ee74ffd1bf56681ffb13d7e33087e506dab8eddc20cea293812984a54b17f173a7e76e39f55029891a83432c1d938ba99f77f06baddc4e5531ff73755558ba4305490d154483bd76921f800cb4e397f0ad2806f7e7931cee772b94c36b5d48e7d8ddfadd79475318d319313c192aa3c139f3826679d73963caab90d466bd5719b7aebbfb2250128b4cc001a7f85823a0262c22380c822f5dce82228b4f5c1628bb1bf97a92c486e0e29ba1320df0674e7949ffb45dcea7beeb0de90c05053e517395df498a51ef366edbb25239a43240c3a1125234fbe3bc12ed2174fdccd3a78d9309319aa22de674f88920b99e6d18a4c3e0970d1602f80b6d51c9dff54bc673ac0673bed491b55427d3f21eedd4999ffbe5e9c283ce0e387217a1cecd4a945d7b393cab340351ef06769b7e39f799a6584a7166db00b205830e8da5ad74f6f28ce8ac5215c030f927d1c1010095623a2b5bba7474e3d0213010d08e80fc7d43a7448085665bc3e3aaa6f36d712cd04367447618a4e4a66629199537f0cd65ce4e48f182df9046319e7fc973bc7c54c56e4141692010095052818ef1e98b381ba56d509e4c932b4152cae82167d3e6c10df20876013bb2267dead63ef8365a08901fcbf53b747274b5fe7b3d17da8b2985fd3b522770a21e1a3fce4ce97b74b8389764aa101df246cbc2470540ac9f82f1d6a96fc03e753848d150a228e6d7a17cbc0ad95fd2ef9c1ee4bc98a2".to_string(),
    }, &mut group);
}

fn rsa_vdf(c: &mut Criterion) {
    let modulus = Rc::new(GOOGLE_RSA_MODULUS_4096.clone());
    let vdf = DefaultRSABasedVDF::new(modulus.clone(), 1000);

    let input = RSAGroupElement::new(BigUint::from(2u64), &modulus);

    println!("Modulus bits: {}", modulus.value.bits());

    let (output, proof) = vdf.evaluate(&input).unwrap();

    c.bench_function("RSA VDF verify", move |b| {
        b.iter(|| vdf.verify(&input, &output, &proof))
    });
}

criterion_group! {
    name = vdf_benchmarks;
    config = Criterion::default().sample_size(100);
    targets = verify, rsa_vdf
}

criterion_main!(vdf_benchmarks);
