<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `fastcrypto-vdf/src/class_group/hash.rs`."><title>hash.rs - source</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-081576b923113409.css"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="fastcrypto_vdf" data-themes="" data-resource-suffix="" data-rustdoc-version="1.79.0 (129f3b996 2024-06-10)" data-channel="1.79.0" data-search-js="search-bf21c90c8c1d92b1.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../../../static.files/storage-e32f0c247825364d.js"></script><script defer src="../../../static.files/src-script-e66d777a5a92e9b2.js"></script><script defer src="../../../src-files.js"></script><script defer src="../../../static.files/main-20a3ad099b048cf2.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-09095024cf37855e.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc src"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="src-sidebar-title"><h2>Files</h2></div></nav><div class="sidebar-resizer"></div><main><nav class="sub"><form class="search-form"><span></span><div id="sidebar-button" tabindex="-1"><a href="../../../fastcrypto_vdf/all.html" title="show sidebar"></a></div><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Type ‘S’ or ‘/’ to search, ‘?’ for more options…" type="search"><div id="help-button" tabindex="-1"><a href="../../../help.html" title="help">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings">Settings</a></div></form></nav><section id="main-content" class="content"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><a href="#1" id="1">1</a>
<a href="#2" id="2">2</a>
<a href="#3" id="3">3</a>
<a href="#4" id="4">4</a>
<a href="#5" id="5">5</a>
<a href="#6" id="6">6</a>
<a href="#7" id="7">7</a>
<a href="#8" id="8">8</a>
<a href="#9" id="9">9</a>
<a href="#10" id="10">10</a>
<a href="#11" id="11">11</a>
<a href="#12" id="12">12</a>
<a href="#13" id="13">13</a>
<a href="#14" id="14">14</a>
<a href="#15" id="15">15</a>
<a href="#16" id="16">16</a>
<a href="#17" id="17">17</a>
<a href="#18" id="18">18</a>
<a href="#19" id="19">19</a>
<a href="#20" id="20">20</a>
<a href="#21" id="21">21</a>
<a href="#22" id="22">22</a>
<a href="#23" id="23">23</a>
<a href="#24" id="24">24</a>
<a href="#25" id="25">25</a>
<a href="#26" id="26">26</a>
<a href="#27" id="27">27</a>
<a href="#28" id="28">28</a>
<a href="#29" id="29">29</a>
<a href="#30" id="30">30</a>
<a href="#31" id="31">31</a>
<a href="#32" id="32">32</a>
<a href="#33" id="33">33</a>
<a href="#34" id="34">34</a>
<a href="#35" id="35">35</a>
<a href="#36" id="36">36</a>
<a href="#37" id="37">37</a>
<a href="#38" id="38">38</a>
<a href="#39" id="39">39</a>
<a href="#40" id="40">40</a>
<a href="#41" id="41">41</a>
<a href="#42" id="42">42</a>
<a href="#43" id="43">43</a>
<a href="#44" id="44">44</a>
<a href="#45" id="45">45</a>
<a href="#46" id="46">46</a>
<a href="#47" id="47">47</a>
<a href="#48" id="48">48</a>
<a href="#49" id="49">49</a>
<a href="#50" id="50">50</a>
<a href="#51" id="51">51</a>
<a href="#52" id="52">52</a>
<a href="#53" id="53">53</a>
<a href="#54" id="54">54</a>
<a href="#55" id="55">55</a>
<a href="#56" id="56">56</a>
<a href="#57" id="57">57</a>
<a href="#58" id="58">58</a>
<a href="#59" id="59">59</a>
<a href="#60" id="60">60</a>
<a href="#61" id="61">61</a>
<a href="#62" id="62">62</a>
<a href="#63" id="63">63</a>
<a href="#64" id="64">64</a>
<a href="#65" id="65">65</a>
<a href="#66" id="66">66</a>
<a href="#67" id="67">67</a>
<a href="#68" id="68">68</a>
<a href="#69" id="69">69</a>
<a href="#70" id="70">70</a>
<a href="#71" id="71">71</a>
<a href="#72" id="72">72</a>
<a href="#73" id="73">73</a>
<a href="#74" id="74">74</a>
<a href="#75" id="75">75</a>
<a href="#76" id="76">76</a>
<a href="#77" id="77">77</a>
<a href="#78" id="78">78</a>
<a href="#79" id="79">79</a>
<a href="#80" id="80">80</a>
<a href="#81" id="81">81</a>
<a href="#82" id="82">82</a>
<a href="#83" id="83">83</a>
<a href="#84" id="84">84</a>
<a href="#85" id="85">85</a>
<a href="#86" id="86">86</a>
<a href="#87" id="87">87</a>
<a href="#88" id="88">88</a>
<a href="#89" id="89">89</a>
<a href="#90" id="90">90</a>
<a href="#91" id="91">91</a>
<a href="#92" id="92">92</a>
<a href="#93" id="93">93</a>
<a href="#94" id="94">94</a>
<a href="#95" id="95">95</a>
<a href="#96" id="96">96</a>
<a href="#97" id="97">97</a>
<a href="#98" id="98">98</a>
<a href="#99" id="99">99</a>
<a href="#100" id="100">100</a>
<a href="#101" id="101">101</a>
<a href="#102" id="102">102</a>
<a href="#103" id="103">103</a>
<a href="#104" id="104">104</a>
<a href="#105" id="105">105</a>
<a href="#106" id="106">106</a>
<a href="#107" id="107">107</a>
<a href="#108" id="108">108</a>
<a href="#109" id="109">109</a>
<a href="#110" id="110">110</a>
<a href="#111" id="111">111</a>
<a href="#112" id="112">112</a>
<a href="#113" id="113">113</a>
<a href="#114" id="114">114</a>
<a href="#115" id="115">115</a>
<a href="#116" id="116">116</a>
<a href="#117" id="117">117</a>
<a href="#118" id="118">118</a>
<a href="#119" id="119">119</a>
<a href="#120" id="120">120</a>
<a href="#121" id="121">121</a>
<a href="#122" id="122">122</a>
<a href="#123" id="123">123</a>
<a href="#124" id="124">124</a>
<a href="#125" id="125">125</a>
<a href="#126" id="126">126</a>
<a href="#127" id="127">127</a>
<a href="#128" id="128">128</a>
<a href="#129" id="129">129</a>
<a href="#130" id="130">130</a>
<a href="#131" id="131">131</a>
<a href="#132" id="132">132</a>
<a href="#133" id="133">133</a>
<a href="#134" id="134">134</a>
<a href="#135" id="135">135</a>
<a href="#136" id="136">136</a>
<a href="#137" id="137">137</a>
<a href="#138" id="138">138</a>
<a href="#139" id="139">139</a>
<a href="#140" id="140">140</a>
<a href="#141" id="141">141</a>
<a href="#142" id="142">142</a>
<a href="#143" id="143">143</a>
<a href="#144" id="144">144</a>
<a href="#145" id="145">145</a>
<a href="#146" id="146">146</a>
<a href="#147" id="147">147</a>
<a href="#148" id="148">148</a>
<a href="#149" id="149">149</a>
<a href="#150" id="150">150</a>
<a href="#151" id="151">151</a>
<a href="#152" id="152">152</a>
<a href="#153" id="153">153</a>
<a href="#154" id="154">154</a>
<a href="#155" id="155">155</a>
<a href="#156" id="156">156</a>
<a href="#157" id="157">157</a>
<a href="#158" id="158">158</a>
<a href="#159" id="159">159</a>
<a href="#160" id="160">160</a>
<a href="#161" id="161">161</a>
<a href="#162" id="162">162</a>
<a href="#163" id="163">163</a>
<a href="#164" id="164">164</a>
<a href="#165" id="165">165</a>
<a href="#166" id="166">166</a>
<a href="#167" id="167">167</a>
<a href="#168" id="168">168</a>
<a href="#169" id="169">169</a>
<a href="#170" id="170">170</a>
<a href="#171" id="171">171</a>
<a href="#172" id="172">172</a>
<a href="#173" id="173">173</a>
<a href="#174" id="174">174</a>
<a href="#175" id="175">175</a>
<a href="#176" id="176">176</a>
<a href="#177" id="177">177</a>
<a href="#178" id="178">178</a>
<a href="#179" id="179">179</a>
<a href="#180" id="180">180</a>
<a href="#181" id="181">181</a>
<a href="#182" id="182">182</a>
<a href="#183" id="183">183</a>
<a href="#184" id="184">184</a>
<a href="#185" id="185">185</a>
<a href="#186" id="186">186</a>
<a href="#187" id="187">187</a>
<a href="#188" id="188">188</a>
<a href="#189" id="189">189</a>
<a href="#190" id="190">190</a>
<a href="#191" id="191">191</a>
<a href="#192" id="192">192</a>
<a href="#193" id="193">193</a>
<a href="#194" id="194">194</a>
<a href="#195" id="195">195</a>
<a href="#196" id="196">196</a>
<a href="#197" id="197">197</a>
<a href="#198" id="198">198</a>
<a href="#199" id="199">199</a>
<a href="#200" id="200">200</a>
<a href="#201" id="201">201</a>
<a href="#202" id="202">202</a>
<a href="#203" id="203">203</a>
<a href="#204" id="204">204</a>
<a href="#205" id="205">205</a>
<a href="#206" id="206">206</a>
<a href="#207" id="207">207</a>
<a href="#208" id="208">208</a>
<a href="#209" id="209">209</a>
<a href="#210" id="210">210</a>
<a href="#211" id="211">211</a>
<a href="#212" id="212">212</a>
<a href="#213" id="213">213</a>
<a href="#214" id="214">214</a>
<a href="#215" id="215">215</a>
<a href="#216" id="216">216</a>
<a href="#217" id="217">217</a>
<a href="#218" id="218">218</a>
<a href="#219" id="219">219</a>
<a href="#220" id="220">220</a>
<a href="#221" id="221">221</a>
<a href="#222" id="222">222</a>
<a href="#223" id="223">223</a>
<a href="#224" id="224">224</a>
<a href="#225" id="225">225</a>
<a href="#226" id="226">226</a>
<a href="#227" id="227">227</a>
<a href="#228" id="228">228</a>
<a href="#229" id="229">229</a>
<a href="#230" id="230">230</a>
<a href="#231" id="231">231</a>
<a href="#232" id="232">232</a>
<a href="#233" id="233">233</a>
<a href="#234" id="234">234</a>
<a href="#235" id="235">235</a>
<a href="#236" id="236">236</a>
<a href="#237" id="237">237</a>
<a href="#238" id="238">238</a>
<a href="#239" id="239">239</a>
<a href="#240" id="240">240</a>
<a href="#241" id="241">241</a>
<a href="#242" id="242">242</a>
<a href="#243" id="243">243</a>
<a href="#244" id="244">244</a>
<a href="#245" id="245">245</a>
<a href="#246" id="246">246</a>
<a href="#247" id="247">247</a>
<a href="#248" id="248">248</a>
<a href="#249" id="249">249</a>
<a href="#250" id="250">250</a>
<a href="#251" id="251">251</a>
<a href="#252" id="252">252</a>
<a href="#253" id="253">253</a>
<a href="#254" id="254">254</a>
<a href="#255" id="255">255</a>
<a href="#256" id="256">256</a>
<a href="#257" id="257">257</a>
<a href="#258" id="258">258</a>
<a href="#259" id="259">259</a>
<a href="#260" id="260">260</a>
</pre></div><pre class="rust"><code><span class="comment">// Copyright (c) 2022, Mysten Labs, Inc.
// SPDX-License-Identifier: Apache-2.0

</span><span class="kw">use </span><span class="kw">crate</span>::class_group::discriminant::Discriminant;
<span class="kw">use </span><span class="kw">crate</span>::class_group::QuadraticForm;
<span class="kw">use </span><span class="kw">crate</span>::math::crt::solve_congruence_equation_system;
<span class="kw">use </span><span class="kw">crate</span>::math::hash_prime::is_probable_prime;
<span class="kw">use </span><span class="kw">crate</span>::math::jacobi;
<span class="kw">use </span><span class="kw">crate</span>::math::modular_sqrt::modular_square_root;
<span class="kw">use </span>fastcrypto::error::FastCryptoError::InvalidInput;
<span class="kw">use </span>fastcrypto::error::FastCryptoResult;
<span class="kw">use </span>fastcrypto::hash::HashFunction;
<span class="kw">use </span>fastcrypto::hash::Sha256;
<span class="kw">use </span>num_bigint::{BigInt, UniformBigInt};
<span class="kw">use </span>num_integer::Integer;
<span class="kw">use </span>num_traits::Signed;
<span class="kw">use </span>rand::distributions::uniform::UniformSampler;
<span class="kw">use </span>rand::{Rng, SeedableRng};
<span class="kw">use </span>rand_chacha::ChaCha8Rng;
<span class="kw">use </span>std::ops::{AddAssign, ShlAssign, Shr};

<span class="kw">impl </span>QuadraticForm {
    <span class="doccomment">/// Generate a random quadratic form from a seed with the given discriminant. This method is deterministic and it is
    /// a random oracle on a large subset of the class group, namely the group elements whose `a` coordinate is a
    /// product of `k` primes all smaller than `(sqrt(|discriminant|)/2)^{1/k}`.
    ///
    /// Increasing `k` speeds-up the function (at least up to some break even point), but it also decreases the size of
    /// the range of the hash function, so `k` must be picked no larger than the `k` computed in [largest_allowed_k]. If
    /// it is larger, an [InvalidInput] error is returned. If in doubt, use the [hash_to_group_with_default_parameters]
    /// instead.
    ///
    /// The algorithm is taken from https://eprint.iacr.org/2024/295.pdf.
    </span><span class="kw">pub fn </span>hash_to_group(
        seed: <span class="kw-2">&amp;</span>[u8],
        discriminant: <span class="kw-2">&amp;</span>Discriminant,
        k: u16,
    ) -&gt; FastCryptoResult&lt;<span class="self">Self</span>&gt; {
        <span class="comment">// Sample a and b such that a &lt; sqrt(|discriminant|)/2 and b is the square root of the discriminant modulo a.
        </span><span class="kw">let </span>(a, <span class="kw-2">mut </span>b) = sample_modulus(discriminant, seed, k)<span class="question-mark">?</span>;

        <span class="comment">// b must be odd but may be negative
        </span><span class="kw">if </span>b.is_even() {
            b -= <span class="kw-2">&amp;</span>a;
        }

        <span class="prelude-val">Ok</span>(QuadraticForm::from_a_b_and_discriminant(a, b, discriminant)
            .expect(<span class="string">"a and b are constructed such that this never fails"</span>))
    }

    <span class="doccomment">/// Generate a random quadratic form from a seed with the given discriminant. This method is deterministic, and it
    /// is a random oracle on a large subset of the class group. This method picks a default `k` parameter and calls the
    /// [hash_to_group](QuadraticForm::hash_to_group) function with this `k`.
    ///
    /// This method returns an InvalidInput error if the discriminant is smaller than 800 bits.
    </span><span class="kw">pub fn </span>hash_to_group_with_default_parameters(
        seed: <span class="kw-2">&amp;</span>[u8],
        discriminant: <span class="kw-2">&amp;</span>Discriminant,
    ) -&gt; FastCryptoResult&lt;<span class="self">Self</span>&gt; {
        <span class="kw">let </span>k = get_default_k(discriminant.bits() <span class="kw">as </span>usize);
        <span class="self">Self</span>::hash_to_group(seed, discriminant, k)
    }
}

<span class="kw">fn </span>get_default_k(discriminant_bits: usize) -&gt; u16 {
    <span class="comment">// This is chosen to ensure that the range of the hash function is large (at least 2^256) but also that the
    // performance is near optimal, based on benchmarks.
    </span><span class="kw">if </span>discriminant_bits &lt;= <span class="number">2048 </span>{
        <span class="number">16
    </span>} <span class="kw">else </span>{
        <span class="number">32
    </span>}
}

<span class="doccomment">/// Increasing `k` reduces the range of the hash function for a given discriminant. This function returns a choice of
/// `k` such that the range is at least `2^256`, and chooses this it as large as possible. Consult the paper for
/// details.
</span><span class="kw">fn </span>largest_allowed_k(discriminant: <span class="kw-2">&amp;</span>Discriminant) -&gt; u16 {
    <span class="kw">let </span>bits = discriminant.bits();
    <span class="kw">let </span>lambda = <span class="number">256.0</span>;
    <span class="kw">let </span>log_b = bits <span class="kw">as </span>f64 / <span class="number">2.0 </span>- <span class="number">1.0</span>;
    <span class="kw">let </span>numerator = log_b - lambda;
    <span class="kw">let </span>denominator = (log_b * <span class="number">2.0_f64</span>.ln()).log2() + <span class="number">1.0</span>;
    (numerator / denominator).floor() <span class="kw">as </span>u16
}

<span class="doccomment">/// Sample a product of `k` primes and return this along with the square root of the discriminant modulo `a`. If `k` is
/// larger than the largest allowed `k` (as computed in [largest_allowed_k]) for the given discriminant, an
/// [InvalidInput] error is returned.
</span><span class="kw">fn </span>sample_modulus(
    discriminant: <span class="kw-2">&amp;</span>Discriminant,
    seed: <span class="kw-2">&amp;</span>[u8],
    k: u16,
) -&gt; FastCryptoResult&lt;(BigInt, BigInt)&gt; {
    <span class="comment">// This heuristic bound ensures that the range of the hash function has size at least 2^256.
    </span><span class="kw">if </span>discriminant.bits() &lt; <span class="number">800 </span>|| k &gt; largest_allowed_k(discriminant) {
        <span class="kw">return </span><span class="prelude-val">Err</span>(InvalidInput);
    }

    <span class="comment">// If a is smaller than this bound and |b| &lt; a, the form is guaranteed to be reduced.
    </span><span class="kw">let </span><span class="kw-2">mut </span>bound: BigInt = discriminant.as_bigint().abs().sqrt().shr(<span class="number">1</span>);
    <span class="kw">if </span>k &gt; <span class="number">1 </span>{
        bound = bound.nth_root(k <span class="kw">as </span>u32);
    }

    <span class="comment">// Seed a rng with the hash of the seed
    </span><span class="kw">let </span><span class="kw-2">mut </span>rng = ChaCha8Rng::from_seed(Sha256::digest(seed).digest);
    <span class="kw">let </span><span class="kw-2">mut </span>factors = Vec::with_capacity(k <span class="kw">as </span>usize);
    <span class="kw">let </span><span class="kw-2">mut </span>square_roots = Vec::with_capacity(k <span class="kw">as </span>usize);

    <span class="kw">for _ in </span><span class="number">0</span>..k {
        <span class="kw">let </span><span class="kw-2">mut </span>factor;
        <span class="kw">loop </span>{
            factor = sample_odd_number(<span class="kw-2">&amp;</span>bound, <span class="kw-2">&amp;mut </span>rng);

            <span class="kw">if </span>factors.contains(<span class="kw-2">&amp;</span>factor) {
                <span class="kw">continue</span>;
            }

            <span class="comment">// The primality check does not try divisions with small primes, so we do it here. This speeds up the
            // algorithm significantly.
            </span><span class="kw">if </span>!trial_division(<span class="kw-2">&amp;</span>factor, <span class="kw-2">&amp;</span>PRIMES) {
                <span class="kw">continue</span>;
            }

            <span class="kw">if </span>jacobi::jacobi(discriminant.as_bigint(), <span class="kw-2">&amp;</span>factor)
                .expect(<span class="string">"factor is odd and positive"</span>)
                == <span class="number">1
                </span>&amp;&amp; is_probable_prime(factor.magnitude())
            {
                <span class="comment">// Found a valid factor
                </span><span class="kw">break</span>;
            }
        }
        <span class="kw">let </span>square_root = modular_square_root(discriminant.as_bigint(), <span class="kw-2">&amp;</span>factor, <span class="bool-val">false</span>)
            .expect(<span class="string">"Legendre symbol checked above"</span>);
        factors.push(factor);
        square_roots.push(square_root);
    }

    <span class="kw">let </span>result = factors.iter().product();
    <span class="kw">let </span>square_root = solve_congruence_equation_system(<span class="kw-2">&amp;</span>square_roots, <span class="kw-2">&amp;</span>factors)
        .expect(<span class="string">"The factors are distinct primes"</span>);

    <span class="prelude-val">Ok</span>((result, square_root))
}

<span class="doccomment">/// Sample a random odd number in [1, bound)
</span><span class="kw">fn </span>sample_odd_number&lt;R: Rng&gt;(bound: <span class="kw-2">&amp;</span>BigInt, rng: <span class="kw-2">&amp;mut </span>R) -&gt; BigInt {
    <span class="kw">let </span><span class="kw-2">mut </span>a = UniformBigInt::new(BigInt::from(<span class="number">1</span>), bound.clone().shr(<span class="number">1</span>)).sample(rng);
    a.shl_assign(<span class="number">1</span>);
    a.add_assign(<span class="number">1</span>);
    a
}

<span class="doccomment">/// The odd primes smaller than 100.
</span><span class="kw">const </span>PRIMES: [u64; <span class="number">24</span>] = [
    <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">17</span>, <span class="number">19</span>, <span class="number">23</span>, <span class="number">29</span>, <span class="number">31</span>, <span class="number">37</span>, <span class="number">41</span>, <span class="number">43</span>, <span class="number">47</span>, <span class="number">53</span>, <span class="number">59</span>, <span class="number">61</span>, <span class="number">67</span>, <span class="number">71</span>, <span class="number">73</span>, <span class="number">79</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">97</span>,
];

<span class="doccomment">/// Perform trial division on `n` with the given primes. Returns true if neither of the divisors divide `n`
</span><span class="kw">fn </span>trial_division(n: <span class="kw-2">&amp;</span>BigInt, divisors: <span class="kw-2">&amp;</span>[u64]) -&gt; bool {
    <span class="kw">for </span>p <span class="kw">in </span>divisors {
        <span class="kw">if </span>n.is_multiple_of(<span class="kw-2">&amp;</span>BigInt::from(<span class="kw-2">*</span>p)) {
            <span class="kw">return </span><span class="bool-val">false</span>;
        }
    }
    <span class="bool-val">true
</span>}

<span class="attr">#[cfg(test)]
</span><span class="kw">mod </span>tests {
    <span class="kw">use </span><span class="kw">crate</span>::class_group::discriminant::Discriminant;
    <span class="kw">use </span><span class="kw">crate</span>::class_group::QuadraticForm;
    <span class="kw">use </span><span class="kw">crate</span>::math::parameterized_group::{Parameter, ParameterizedGroupElement};
    <span class="kw">use </span>num_bigint::BigInt;
    <span class="kw">use </span>num_traits::Num;
    <span class="kw">use </span>rand::thread_rng;
    <span class="kw">use </span>rand::RngCore;

    <span class="attr">#[test]
    </span><span class="kw">fn </span>test_qf_from_seed() {
        <span class="kw">let </span><span class="kw-2">mut </span>seed = [<span class="number">0u8</span>; <span class="number">32</span>];
        <span class="kw">let </span>discriminant = Discriminant::from_seed(<span class="kw-2">&amp;</span>seed, <span class="number">1024</span>).unwrap();

        <span class="kw">for _ in </span><span class="number">0</span>..<span class="number">10 </span>{
            <span class="kw">let </span>qf = QuadraticForm::hash_to_group(<span class="kw-2">&amp;</span>seed, <span class="kw-2">&amp;</span>discriminant, <span class="number">1</span>).unwrap();
            <span class="macro">assert!</span>(qf.is_reduced_assuming_normal());
            <span class="macro">assert!</span>(qf.is_in_group(<span class="kw-2">&amp;</span>discriminant));
            seed[<span class="number">0</span>] += <span class="number">1</span>;
        }

        <span class="kw">for _ in </span><span class="number">0</span>..<span class="number">10 </span>{
            <span class="kw">let </span>qf = QuadraticForm::hash_to_group(<span class="kw-2">&amp;</span>seed, <span class="kw-2">&amp;</span>discriminant, <span class="number">4</span>).unwrap();
            <span class="macro">assert!</span>(qf.is_reduced_assuming_normal());
            <span class="macro">assert!</span>(qf.is_in_group(<span class="kw-2">&amp;</span>discriminant));
            seed[<span class="number">0</span>] += <span class="number">1</span>;
        }
    }

    <span class="attr">#[test]
    </span><span class="kw">fn </span>qf_from_seed_sanity_tests() {
        <span class="kw">let </span>discriminant = Discriminant::from_seed(<span class="string">b"discriminant seed"</span>, <span class="number">800</span>).unwrap();
        <span class="kw">let </span>base_qf = QuadraticForm::hash_to_group(<span class="string">b"qf seed"</span>, <span class="kw-2">&amp;</span>discriminant, <span class="number">6</span>).unwrap();
        <span class="macro">assert!</span>(base_qf.is_in_group(<span class="kw-2">&amp;</span>discriminant));

        <span class="comment">// Same seed, same discriminant, same k
        </span><span class="kw">let </span>other_qf = QuadraticForm::hash_to_group(<span class="string">b"qf seed"</span>, <span class="kw-2">&amp;</span>discriminant, <span class="number">6</span>).unwrap();
        <span class="macro">assert_eq!</span>(base_qf, other_qf);

        <span class="comment">// Smaller k
        </span><span class="kw">let </span>other_qf = QuadraticForm::hash_to_group(<span class="string">b"qf seed"</span>, <span class="kw-2">&amp;</span>discriminant, <span class="number">5</span>).unwrap();
        <span class="macro">assert_ne!</span>(base_qf, other_qf);

        <span class="comment">// Larger k
        </span><span class="kw">let </span>other_qf = QuadraticForm::hash_to_group(<span class="string">b"qf seed"</span>, <span class="kw-2">&amp;</span>discriminant, <span class="number">7</span>).unwrap();
        <span class="macro">assert_ne!</span>(base_qf, other_qf);

        <span class="kw">let </span><span class="kw-2">mut </span>seed = [<span class="number">0u8</span>; <span class="number">32</span>];
        <span class="kw">for _ in </span><span class="number">0</span>..<span class="number">10 </span>{
            <span class="comment">// Different seed
            </span>thread_rng().fill_bytes(<span class="kw-2">&amp;mut </span>seed);
            <span class="kw">let </span>other_qf = QuadraticForm::hash_to_group(<span class="kw-2">&amp;</span>seed, <span class="kw-2">&amp;</span>discriminant, <span class="number">6</span>).unwrap();
            <span class="macro">assert_ne!</span>(base_qf, other_qf);
        }

        <span class="kw">let </span>other_discriminant = Discriminant::from_seed(<span class="string">b"other discriminant seed"</span>, <span class="number">800</span>).unwrap();
        <span class="comment">// Same seed, same k, other discriminant
        </span><span class="kw">let </span>other_qf = QuadraticForm::hash_to_group(<span class="string">b"qf seed"</span>, <span class="kw-2">&amp;</span>other_discriminant, <span class="number">6</span>).unwrap();
        <span class="macro">assert_ne!</span>(base_qf, other_qf);
    }

    <span class="attr">#[test]
    </span><span class="kw">fn </span>qf_from_seed_regression_tests() {
        <span class="kw">let </span>discriminant = Discriminant::from_trusted_bigint(-BigInt::from_str_radix(<span class="string">"c3811f4ad2f4a7bdf2ed89385866ad526c6dd3aa942e04c141d0562a8e7b014f08804f47b3c2ecbba0a5a0ad8f4d8e869a10cff13dbc522aea141f6d1c42913f2d3bff8d3e7656c72523a2e9d47f838234bd65f05ef3ca86c2f640bca6630ed8d1da21e30a67f83e25b89c32c2d0dc0bacb81bd971b0932a82d131b4a74bff36b60b66543105da2c3ecb1a4e8c2cb6d47c1e85942cce8f3fc50c27856e6dfbd15c0bd5017fea15ae0eb43dfb32b2d947c3131d1951f00bcc40352eeb65e364551e40d13768f443406760ee6b37a5b5819d3f630c034c7f42212ad49c803772aaafd4cd1f87697c68d5a6b0855f475b370b20058558993e76759caa38edbc82407b4e3559bade5f7479a860ebef62fed82d657765ebb8f7f375c2b78f73669760e4bd4932177087a49a0b68d7"</span>, <span class="number">16</span>).unwrap());

        <span class="kw">let </span>qf = QuadraticForm::hash_to_group(<span class="string">b"seed"</span>, <span class="kw-2">&amp;</span>discriminant, <span class="number">64</span>).unwrap();
        <span class="macro">assert_eq!</span>(bcs::to_bytes(<span class="kw-2">&amp;</span>qf).unwrap(), hex::decode(<span class="string">"8b0104397d87d59220ec1bbbf79f471689ad0a48f67625abed478749b2f110d79990684b782160a7e00288c240160d10da0198298fd68f7e3fa0964975f1816d5bb38c978ea1bc9fb5aaefa62971435de9565801c80e545b497d00783c0d518722311c6fa7e924bff4f4765f6f3c6b3de8dcf1c314e7ea8df998de524af394e5cec7dfc867cf07f7eb501dfc279102ff304620732b3d44d3ceeadbd054e20eb953eed85ac684044b1192c1ccaeb9ba79695b28204e7148e8560e4b782c6b20ea20123bda9061eed1920d7ff1fd9741220ee1fac09f596524a12aa993734f2fa4ccf792d46c3bf8320073def0c938e6fb608b8866f70fc380f1a37f3fd9c52935837f5ff06ef6ab882599460e7b950ab17a75602a0b29523ab99c4d030923244a5a9e0431759c59a33a471641c013dadaebdc711baf3a05320330959f13b88c6619c64201bc10517c0bbc69524e6d3345eaeade453ea1ebe8b4ce41068e321399c41e8a90831f9713aa2df564423dfa2fe36e65ccf8157c9ebd24f4ac545482b1a609b7bce94316af8e53cbe191ba073b312a60831ea1f657a92ded17350710ed960309f9853536dd6c8dc45ed0069b1feb7e4acbc7adcf15252e96d5c35e37afbd5b6c413c8511e8225b0f938ae03225b5f2a856aed3551f424795b08807fdc0e38566acdebd699e4db85cf216e3467e9ca3d6c82cfaf77d8446e612de64b1fd3a5df8c5a982df1470daf56f3a15787b35439769c6003693c9b88bf14962b40995931baad12c0e00ac9456556deee599db40209dffe5ebf04f193776ba1dbf3c6fa1a81daafb80ec83e9ce0f8365b8f8fffedf13fe1c2d34d12c2bc5c3c223dd1ea6158645d229e65ccf774c04e4aa4715a67d20f2a20752553c30410651990bbb27d1be95c8b690c7a4edd6450ecbeef312e862944c3eeac7ad25541c14aa6c3da7c14bb4ab6119be67dda0ff244b18711c3da20570ecc1536c3c5cfe297bce254df07fe52d05f54d59272d1fe8c6b30c0eb60a6154b86c71e48379a109986a3632dea79fa0e77fe49931abae8a9188163dc388e772342c0f66d90791a3dd8e337211884aea2b7c2f7920862ade85b6e93d4b1e6afe44a0bf62ed509917cde6ef93a8f6dcd763831652e5c193b7b7ed7d9bb937d1ca1870"</span>).unwrap());

        <span class="kw">let </span>qf = QuadraticForm::hash_to_group(<span class="string">b"seed"</span>, <span class="kw-2">&amp;</span>discriminant, <span class="number">32</span>).unwrap();
        <span class="macro">assert_eq!</span>(bcs::to_bytes(<span class="kw-2">&amp;</span>qf).unwrap(), hex::decode(<span class="string">"91010131e81a0ad42da693099a5c3756a494a32be2f80055634b6ffad271b03a1da3d4fd94d310d63ba16dcfaff8ec034215db89aac493573a399d3ecd0db3418234a96ad8cd92f93b3f9d5964e1e7b6d89c4ea7cecaf8a8b86d3ea039b5b47d76cba90539317efc131a8d25b14c2effe966ffdde5151babfe3f5604c1edbc82132c66a8941edd2fa3392b101770d3e0cb90c19702e4aa2da476751cc4ff0a848db4dfbe56ee3e9f09922b3f55c8a0374a2c296fc5a73fc259375d2a931c8e1515cb872005ed5a50ee85ee663b6130254d389c4092d945490e92deeaf27f91d684509ec1b9dd718f01a041d3ade398fac284c3b220950c8832d030d6b0236fa5e6626f63ec0be64f66d82cdcb45f70a169a2c0fff664d1c37f8fafc0153b9f6aeeff986bf056ec5953fc362fcb229a359053f1393a6cbdecc8a0b3e5853be996b0d0ba7a660c00ed6728f4762f01009c8b8ad12b493e8f3e3e9d58837e42372586101e585d40a1715271afe41fe435a57921bd9acd4fcbadfd4e4396812727c3c5fe100296e01d3baa8d9bbc37904080dfcb4860ba8476ac1a0af200244fc8028e71ff7b3a58a85341cb0cdf9e03009c53fa427eea51d6703ddba90c70752d84d76685cb64596f335f74445d15d6463516126d2d3fc32871d472192a555847da6dbccb08396013a444c2f900de32ae5df6bdd8bdc7e870eef02f5a953194d831baaa8f653fc59fb3513b0c3ec5206dd3c41c0ee72f70ddba4d3ae0245928ceb1b0d8f59f5133d0f7647187094652cf6773aab2d05fa0a0b161ba19ae4f954c2d80bfdacb0c51ee2d5ad1b25240e348b4472db239d2dbc6864af6e1425d88a94b3ce8a8f6d754799c59609ab095a469cda07869fff1ad558fe0517a6c35018d224ca52af18537e460345e38a579af48b1043392312d8ed9c868f72993d092843c939817102e89db737c3509eea800be399800de35570a0d255369b9c49013e208c598570a6c888424651ed5b371bedfc571c30e39d971d262bdf3a4b4d60b5f29ec7fac14b8fcb4c654d346c7313113c027605bce2c2464827ff44f1b839be19025014cf8d291455bc67aa4277edd4e3ded467778611d3f7da4e3002eef718a5110b000af428dc3be5e59e89ec798f56310b099464e7c765b8f1c84f1e67205feb6376338925be58657093046"</span>).unwrap());

        <span class="kw">let </span>qf = QuadraticForm::hash_to_group(<span class="string">b"seed"</span>, <span class="kw-2">&amp;</span>discriminant, <span class="number">16</span>).unwrap();
        <span class="macro">assert_eq!</span>(bcs::to_bytes(<span class="kw-2">&amp;</span>qf).unwrap(), hex::decode(<span class="string">"9401031797d54ddb89c329b525b1aa6e3f1e193d93056b3c19d34b422c0f65212f9abacb807116fff67eeac9e73c8aa6e57a8eecea4e3fb78551d277831baf6e657afbfe99c063af48fd67a6f9b48174f9f4207caaba39eb90bbe09318597473fb281bc3e95ea6dc8ad773c826d4a97452253f7c7662593bee386d0d1d4a7596ea810661e0391c0ab005642dc1dcc33649340c408dc194022d85bd17b5e06fc59ab741554454d0450e12b4007c0aae9bb68ca4d9f1edac4fcd1577d8a4b23ea5d487f11acee384e71e4c6037b17cd60c496c099be926d21b52bfabccfe4e402abac837b9b0818ef0e4172039baf9d46a3c2864866870df86e8f1e3bd813a53b2d217d0234bfe67f245398aad77f8db7cde11c259f247ae96d5af982ddf8cf7dad2b0225eece2de9ee00c83fb8cb32ba7f77599033b4a2ad35712ab0cc6eb69d67cfde5b6647fca0ebb9b3a7db0092bd8a31c509dfea38d961fe24ad5fa68f73ae5bd5b42538cfe62874e8a8d0f72f52492524791ad51d70e433dcd988033ab4be061cdab0b9b7d960625cde8430dd16e02b2bb1ff510231f59262dd93a796ccf99825f3f1144e58667303509950300a78b3c507be066b2aa31ed2cbbc4de664d27561825164240eb639860a561c0bd8abe11790dc875f2a13c6171c9eda777a03f5a4258b99639ded20b938c5c494223aa72e9d612471ae0e54967af8730bd54a32e408511adcab4816a95b1c9924f56adaf60be01715c02fb80b35f531cf1298f661fe8e40cf1f800444a291e26303e79291db8900067069fe203e97376b88f6ada38ece7e04f87241fd1bb395076621c0a339cb283ca960a8252d95f4d4fe0c3435943285ca9de7df811fd1642862a9fdacb258ed05e27cbf7001b7804a0421f5ae0eca95dce9aa5c6d8b873ee0eb696db556d4e12c246eacf93c1e6f2feee2a73301540101cf2154c94cc2ef7a656e0d65aa78316756b875d27100d151b1cbf5dabb185429ed20693a7a395703f99e27e88c7b5b919fec492e59299b8bb1abcf451ac7f0ec4789dbf4a95835a5da0569f83440045a654e28d313212dd56b01627c6edf27f261dd75336bda675f698887771b9afd28ca8b3379cbbcffb373cb8803738e48fd5f286f77c40c1bc94e47eccefce38be9de1be9a22751634bf6cd2cf4a"</span>).unwrap());

        <span class="kw">let </span>qf = QuadraticForm::hash_to_group(<span class="string">b"seed"</span>, <span class="kw-2">&amp;</span>discriminant, <span class="number">8</span>).unwrap();
        <span class="macro">assert_eq!</span>(bcs::to_bytes(<span class="kw-2">&amp;</span>qf).unwrap(), hex::decode(<span class="string">"950166d2bf1d0ad57988b9b6a789fc2acab4ae89fa080022a9cc9566a5c0b67cf4f6d1a2a7ad0d4488ecea1c59cec64de1d424273065e2186a08a8ee37fc8f7a2cc34a167224133f78e47eceb3dc9781655289ed9c988f5267f5ba3fb1173d7f52071e9b9a3bf196b6db657c227245222b6871c04e2956d37543d8b3f422722c486b10e82bff46b35c15415e1dbbf5b0f84159dd961aef8502fed697e8c66401370be358a98d8648f0385bf2a72705767f8a37b8c3bd0a0c7824944b4ff1b109094d6fa19e063d5a3ec1a8475f9820bbc9ce10cb45095de0daeaa227277a87d6aefff2068c8cbd95358b54a4ed151a86858362b91f86b283707239c2d4661a847917508fe3ec8df2f928879b4a3ebea2373daa233314fd1c36f4ee264f1e1913c54bc388f6b911f9ba322bd33361db6988acf37589332459068175ede93967f8ea9442e77117e22d7d8c53a42b1a3279c357068df9584ac2b6024b952a9ba7011469a37cd470d9d8443bde67c696b2cee2cd55ad5da2d34c9b63f132bc2c4182f415d72c8343ab313ba4ad527ab886badec927fc0f1d829f894a3a34a32df40200d70e22e98c42fa7b109e6c3fcc6a36f423efee520d588e0fb4a78e2bb997f3c6162c3cec1363150406e3142b4716f8c148e91d0d4cc818cb330b0bbd14ecfe39145ee71b36018366f417774554181437d1787458cc8fd3f0c25a27696de5e285209fcfe2cad01be819c1c16027903033114e56a049e4a57f5afe8d87e6032c107a77caeec944aeb3e707af8a446e17b07aa2e6c551eb768037ad96ca1f28939cd8154cd7f98abed95ae96920f88a820d1cdc4ed8bff892bede47606bd4c6c3f4431256ecf3ff3aeecd668aa4a1da0c90a14562e172bf32c281a83f688cda5fcb756c9d353c9a665744ba94332212f87ab512ae36778cf0e760c35500158163accb440b24713a48b789c03da2e348b99234277055dce5d92a05b9587a4cd283739c7ae4c8552d4d7088946ce693de313f955eee31c1f5d2aa3087dd9d3629ab9c95ab0ee7659b1e0a49d4bb6a441f821b88b88d7cec5fd225f6dcd076608b1f80c6561c43b747bebdbc3e636bb29e7675474b50"</span>).unwrap());

        <span class="kw">let </span>qf = QuadraticForm::hash_to_group(<span class="string">b"seed"</span>, <span class="kw-2">&amp;</span>discriminant, <span class="number">4</span>).unwrap();
        <span class="macro">assert_eq!</span>(bcs::to_bytes(<span class="kw-2">&amp;</span>qf).unwrap(), hex::decode(<span class="string">"960102d12a2199c0d002e25d9f3ab2972ca4a625d272801e86da11690b28ce005e83ac8f58d6ff97945d2e15a6fba11dd37b3ada8ef8cc2e8fe505fcc470dbd76562992c9ac14f02febcd05ee14dae7f611cce78676d1301dfc97c8c2c0d49ee00a5d6bd9ab50540a533518c7cf58f7756a74595ae10a759d0cd6e72f557193a1a7d7a68ec180bb985aef1f1f64ed10637041069d343de99e001f9e5bf7c4c79a58012dcbf3c8c062dd4971ab88176c6dfd1ce314d85f98c31ba67c1dd99ce3f7d2a04be56deaec618436e6cc5fc68d9417d955478f04dfc0af4e85726e3f1c0a7d9613d3b994035efbd1fcc90a2186895f43732b787b717211b882227496de79dd3cb6d3387ee8041a6d9a9dfa83af3fbbe57e89b408077241fe0aef8dd585982205c7d846921421ffcc84e455cd60fa9c15f13b31d5e1a96f4ed37506571baf9eb935f8b7aa184b94ea3662db78cda03164e34490c7cf2e74c4cc68793e855b0c0d1e3a4c7683102a114480629f5373bcac4ea28e6a0601a3baa02034e12ac78243002acf5441c693308133fbff6e1aa6e5ab5c904cf41f94febd3a2847b54e516c9ca42bbc08695cd3ab07f4d1ca8d41108bf552cdbdebdd3a3cfcb3d296245b86ec788c4315f8ce03565e5bc6cf27babc4585874ee1cc64dd487fc7c43a1c82ab47783d05c7a7347cd6efe0645a746ce3a131649a8047a832665232be81d006da67ed832691ba8d32e9374b2f38a40d127dd677d011f2d9840b27b4817bb3bd98083c7260dc8ec9ccc75ab19512a05a6e36cf27518415b2f65adc79fab3cbf71836b07a6395870c4b55d8d973266a0658e497effe0ecf23a2109b68a8d8b6c8d33d122122f9787a3d63b0c85b2698156d759cfb4d8a1fb656ca002d9c84c7ec74fddccbe097c73a36fc8a4f51b29374970e16c8da0ad99cc0d18e48323376757205a6efc"</span>).unwrap());
    }

    <span class="attr">#[test]
    </span><span class="kw">fn </span>qf_default_hash_test() {
        <span class="kw">let </span>discriminant = Discriminant::from_trusted_bigint(-BigInt::from_str_radix(<span class="string">"c3811f4ad2f4a7bdf2ed89385866ad526c6dd3aa942e04c141d0562a8e7b014f08804f47b3c2ecbba0a5a0ad8f4d8e869a10cff13dbc522aea141f6d1c42913f2d3bff8d3e7656c72523a2e9d47f838234bd65f05ef3ca86c2f640bca6630ed8d1da21e30a67f83e25b89c32c2d0dc0bacb81bd971b0932a82d131b4a74bff36b60b66543105da2c3ecb1a4e8c2cb6d47c1e85942cce8f3fc50c27856e6dfbd15c0bd5017fea15ae0eb43dfb32b2d947c3131d1951f00bcc40352eeb65e364551e40d13768f443406760ee6b37a5b5819d3f630c034c7f42212ad49c803772aaafd4cd1f87697c68d5a6b0855f475b370b20058558993e76759caa38edbc82407b4e3559bade5f7479a860ebef62fed82d657765ebb8f7f375c2b78f73669760e4bd4932177087a49a0b68d7"</span>, <span class="number">16</span>).unwrap());

        <span class="kw">let </span>qf =
            QuadraticForm::hash_to_group_with_default_parameters(<span class="string">b"seed"</span>, <span class="kw-2">&amp;</span>discriminant).unwrap();
        <span class="macro">assert_eq!</span>(bcs::to_bytes(<span class="kw-2">&amp;</span>qf).unwrap(), hex::decode(<span class="string">"91010131e81a0ad42da693099a5c3756a494a32be2f80055634b6ffad271b03a1da3d4fd94d310d63ba16dcfaff8ec034215db89aac493573a399d3ecd0db3418234a96ad8cd92f93b3f9d5964e1e7b6d89c4ea7cecaf8a8b86d3ea039b5b47d76cba90539317efc131a8d25b14c2effe966ffdde5151babfe3f5604c1edbc82132c66a8941edd2fa3392b101770d3e0cb90c19702e4aa2da476751cc4ff0a848db4dfbe56ee3e9f09922b3f55c8a0374a2c296fc5a73fc259375d2a931c8e1515cb872005ed5a50ee85ee663b6130254d389c4092d945490e92deeaf27f91d684509ec1b9dd718f01a041d3ade398fac284c3b220950c8832d030d6b0236fa5e6626f63ec0be64f66d82cdcb45f70a169a2c0fff664d1c37f8fafc0153b9f6aeeff986bf056ec5953fc362fcb229a359053f1393a6cbdecc8a0b3e5853be996b0d0ba7a660c00ed6728f4762f01009c8b8ad12b493e8f3e3e9d58837e42372586101e585d40a1715271afe41fe435a57921bd9acd4fcbadfd4e4396812727c3c5fe100296e01d3baa8d9bbc37904080dfcb4860ba8476ac1a0af200244fc8028e71ff7b3a58a85341cb0cdf9e03009c53fa427eea51d6703ddba90c70752d84d76685cb64596f335f74445d15d6463516126d2d3fc32871d472192a555847da6dbccb08396013a444c2f900de32ae5df6bdd8bdc7e870eef02f5a953194d831baaa8f653fc59fb3513b0c3ec5206dd3c41c0ee72f70ddba4d3ae0245928ceb1b0d8f59f5133d0f7647187094652cf6773aab2d05fa0a0b161ba19ae4f954c2d80bfdacb0c51ee2d5ad1b25240e348b4472db239d2dbc6864af6e1425d88a94b3ce8a8f6d754799c59609ab095a469cda07869fff1ad558fe0517a6c35018d224ca52af18537e460345e38a579af48b1043392312d8ed9c868f72993d092843c939817102e89db737c3509eea800be399800de35570a0d255369b9c49013e208c598570a6c888424651ed5b371bedfc571c30e39d971d262bdf3a4b4d60b5f29ec7fac14b8fcb4c654d346c7313113c027605bce2c2464827ff44f1b839be19025014cf8d291455bc67aa4277edd4e3ded467778611d3f7da4e3002eef718a5110b000af428dc3be5e59e89ec798f56310b099464e7c765b8f1c84f1e67205feb6376338925be58657093046"</span>).unwrap());
    }
}
</code></pre></div></section></main></body></html>